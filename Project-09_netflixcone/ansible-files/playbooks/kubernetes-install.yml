---
- name: Provision and Setup Kubernetes Cluster and Jenkins
  hosts: all
  become: yes
  vars:
    jenkins_admin_user: "admin"
    jenkins_admin_password: "admin123"
    required_plugins:
      - adoptopenjdk
      - sonar
      - nodejs
      - dependency-check-jenkins-plugin
      - docker-workflow
      - kubernetes
      - pipeline-utility-steps
      - git
      - email-ext
      - docker-plugin
      - prometheus
      - email-ext
    jenkins_admin_email: "lakshmi.rajyam06@gmail.com"
    jenkins_smtp_server: "smtp.example.com"
    jenkins_smtp_port: 587
    jenkins_smtp_user: "smtp_user"
    jenkins_smtp_password: "smtp_password"
    prometheus_version: "2.30.3"
    grafana_version: "8.3.3"
    grafana_user: "admin"
    grafana_password: "admin123"
    docker_image_name: "nalla06/netflix-clone:latest"
    docker_registry: "docker.io"
    docker_registry_user: "nalla06"
    docker_registry_password: "kondapalli"
    kubernetes_master_ip: "192.168.1.100"
    kubernetes_slave_ip: "192.168.1.101"

  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Add user to Docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Install Kubernetes packages
      shell: |
        sudo curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        sudo tee /etc/apt/sources.list.d/kubernetes.list <<EOF
        deb https://apt.kubernetes.io/ kubernetes-xenial main
        EOF
        sudo apt-get update
        sudo apt-get install -y kubelet kubeadm kubectl
        sudo snap install kube-apiserver

    - name: Initialize Kubernetes master node
      shell: |
        sudo kubeadm init --pod-network-cidr=10.244.0.0/16
        mkdir -p $HOME/.kube
        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        sudo chown $(id -u):$(id -g) $HOME/.kube/config
        kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
      when: inventory_hostname == 'kubernetes-master'

    - name: Join worker node to the cluster
      shell: |
        sudo kubeadm join {{ kubernetes_master_ip }}:6443 --token <token> --discovery-token-ca-cert-hash <hash>
      when: inventory_hostname == 'kubernetes-worker'

    - name: Install Node Exporter on master and worker nodes
      shell: |
        sudo useradd --system --no-create-home --shell /bin/false node_exporter
        wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
        tar -xvf node_exporter-1.6.1.linux-amd64.tar.gz
        sudo mv node_exporter-1.6.1.linux-amd64/node_exporter /usr/local/bin/
        rm -rf node_exporter*
        sudo tee /etc/systemd/system/node_exporter.service <<EOF
        [Unit]
        Description=Node Exporter
        Wants=network-online.target
        After=network-online.target
        StartLimitIntervalSec=500
        StartLimitBurst=5
        [Service]
        User=node_exporter
        Group=node_exporter
        Type=simple
        Restart=on-failure
        RestartSec=5s
        ExecStart=/usr/local/bin/node_exporter --collector.logind
        [Install]
        WantedBy=multi-user.target
        EOF
        sudo systemctl enable node_exporter
        sudo systemctl start node_exporter

    - name: Configure Prometheus targets
      shell: |
        sudo tee -a /etc/prometheus/prometheus.yml <<EOF
        - job_name: node_export_masterk8s
          static_configs:
            - targets: ["{{ kubernetes_master_ip }}:9100"]
        - job_name: node_export_workerk8s
          static_configs:
            - targets: ["{{ kubernetes_slave_ip }}:9100"]
        EOF
        promtool check config /etc/prometheus/prometheus.yml
        curl -X POST http://localhost:9090/-/reload

    - name: Wait for Jenkins to be fully operational
      uri:
        url: "http://localhost:8080/login"
        status_code: 200
        validate_certs: no
      register: jenkins_status
      retries: 30
      delay: 10
      until: jenkins_status.status == 200

    - name: Download Jenkins CLI
      get_url:
        url: "http://localhost:8080/jnlpJars/jenkins-cli.jar"
        dest: /tmp/jenkins-cli.jar
        mode: '0755'

    - name: Get list of installed plugins
      shell: |
        java -jar /tmp/jenkins-cli.jar -s http://localhost:8080 -auth {{ jenkins_admin_user }}:{{ jenkins_admin_password }} list-plugins | cut -f 1 -d ' '
      register: installed_plugins
      ignore_errors: yes

    - name: Install Jenkins plugins
      shell: |
        java -jar /tmp/jenkins-cli.jar -s http://localhost:8080 -auth {{ jenkins_admin_user }}:{{ jenkins_admin_password }} install-plugin {{ item }} -deploy
      register: plugin_install
      until: plugin_install.rc == 0
      retries: 3
      delay: 15
      with_items: "{{ required_plugins }}"
      when: item not in installed_plugins.stdout_lines
      ignore_errors: yes

    - name: Wait before restart
      pause:
        seconds: 30
      when: plugin_install.changed

    - name: Restart Jenkins
      shell: |
        java -jar /tmp/jenkins-cli.jar -s http://localhost:8080 -auth {{ jenkins_admin_user }}:{{ jenkins_admin_password }} safe-restart
      async: 300
      poll: 0
      when: plugin_install.changed

    - name: Wait for Jenkins to become available after restart
      uri:
        url: "http://localhost:8080/login"
        status_code: 200
        validate_certs: no
      register: jenkins_status
      retries: 30
      delay: 10
      until: jenkins_status.status == 200
      when: plugin_install.changed

    - name: Create Jenkins pipeline job
      shell: |
        java -jar /tmp/jenkins-cli.jar -s http://localhost:8080 -auth {{ jenkins_admin_user }}:{{ jenkins_admin_password }} create-job my-pipeline <<EOF
        <flow-definition plugin="workflow-job">
          <actions/>
          <description>My Pipeline Project</description>
          <keepDependencies>false</keepDependencies>
          <properties/>
          <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps">
            <script>
              pipeline {
                agent any
                tools {
                  jdk 'jdk17'
                  nodejs 'node16'
                }
                environment {
                  SCANNER_HOME = tool 'sonar-scanner'
                }
                stages {
                  stage('Clean Workspace') {
                    steps {
                      cleanWs()
                    }
                  }
                  stage('Checkout from Git') {
                    steps {
                      git branch: 'main', url: 'https://github.com/Aj7Ay/Netflix-clone.git'
                    }
                  }
                  stage('SonarQube Analysis') {
                    steps {
                      withSonarQubeEnv('sonar-server') {
                        sh '''
                          $SCANNER_HOME/bin/sonar-scanner \
                          -Dsonar.projectName=Netflix \
                          -Dsonar.projectKey=Netflix
                        '''
                      }
                    }
                  }
                  stage('Quality Gate') {
                    steps {
                      script {
                        waitForQualityGate abortPipeline: false, credentialsId: 'Sonar-token'
                      }
                    }
                  }
                  stage('Install Dependencies') {
                    steps {
                      sh 'npm install'
                    }
                  }
                  stage('OWASP Dependency Check') {
                    steps {
                      dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                      dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                    }
                  }
                  stage('TRIVY FS Scan') {
                    steps {
                      sh 'trivy fs . > trivyfs.txt'
                    }
                  }
                  stage('Docker Build & Push') {
                    steps {
                      script {
                        withDockerRegistry(credentialsId: 'docker', toolName: 'docker') {
                          sh 'docker build --build-arg TMDB_V3_API_KEY=Aj7ay86fe14eca3e76869b92 -t netflix .'
                          sh 'docker tag netflix nalla06/netflix-clone:latest'
                          sh 'docker push nalla06/netflix-clone:latest'
                        }
                      }
                    }
                  }
                  stage('TRIVY Image Scan') {
                    steps {
                      sh 'trivy image nalla06/netflix-clone:latest > trivyimage.txt'
                    }
                  }
                  stage('Deploy to Container') {
                    steps {
                      sh 'docker run -d --name netflix -p 8081:8080 nalla06/netflix-clone:latest'
                    }
                  }
                  stage('Deploy to Kubernetes') {
                    steps {
                      script {
                        dir('Kubernetes') {
                          withKubeConfig(caCertificate: '', clusterName: '', contextName: '', credentialsId: 'k8s', namespace: '', restrictKubeConfigAccess: false, serverUrl: '') {
                            sh 'kubectl apply -f deployment.yml'
                            sh 'kubectl apply -f service.yml'
                          }
                        }
                      }
                    }
                  }
                }
                post {
                  always {
                    emailext attachLog: true,
                      subject: "'${currentBuild.result}'",
                      body: "Project: ${env.JOB_NAME}<br/>" +
                            "Build Number: ${env.BUILD_NUMBER}<br/>" +
                            "URL: ${env.BUILD_URL}<br/>",
                      to: 'rutik@gmail.com',
                      attachmentsPattern: 'trivyfs.txt,trivyimage.txt'
                  }
                }
              }
            </script>
            <sandbox>true</sandbox>
          </definition>
          <triggers/>
          <disabled>false</disabled>
        </flow-definition>
        EOF